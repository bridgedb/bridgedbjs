<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: organism-service.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"bridgedbjs","disqus":"true","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">bridgedbjs</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="Bridgedb">
            <span class="title">
                <a href="Bridgedb.html">Bridgedb</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.databaseService">
            <span class="title">
                <a href="bridgedb.databaseService.html">bridgedb.databaseService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.entityReferenceService">
            <span class="title">
                <a href="bridgedb.entityReferenceService.html">bridgedb.entityReferenceService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.entityReferenceService~addIdentifiersIri"><a href="bridgedb.entityReferenceService.html#addIdentifiersIri">addIdentifiersIri</a></li>
            
                <li data-name="bridgedb.entityReferenceService~enrich"><a href="bridgedb.entityReferenceService.html#enrich">enrich</a></li>
            
                <li data-name="bridgedb.entityReferenceService~exists"><a href="bridgedb.entityReferenceService.html#exists">exists</a></li>
            
                <li data-name="bridgedb.entityReferenceService~map"><a href="bridgedb.entityReferenceService.html#map">map</a></li>
            
                <li data-name="bridgedb.entityReferenceService~normalize"><a href="bridgedb.entityReferenceService.html#normalize">normalize</a></li>
            
                <li data-name="bridgedb.entityReferenceService~searchByAttribute"><a href="bridgedb.entityReferenceService.html#searchByAttribute">searchByAttribute</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.organismService">
            <span class="title">
                <a href="bridgedb.organismService.html">bridgedb.organismService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.organismService~convertEntityReferenceIriToOrganismName"><a href="bridgedb.organismService.html#convertEntityReferenceIriToOrganismName">convertEntityReferenceIriToOrganismName</a></li>
            
                <li data-name="bridgedb.organismService~getAvailable"><a href="bridgedb.organismService.html#getAvailable">getAvailable</a></li>
            
                <li data-name="bridgedb.organismService~getByEntityReference"><a href="bridgedb.organismService.html#getByEntityReference">getByEntityReference</a></li>
            
                <li data-name="bridgedb.organismService~getByIri"><a href="bridgedb.organismService.html#getByIri">getByIri</a></li>
            
                <li data-name="bridgedb.organismService~normalize"><a href="bridgedb.organismService.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.xrefService">
            <span class="title">
                <a href="bridgedb.xrefService.html">bridgedb.xrefService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.xrefService~createStream"><a href="bridgedb.xrefService.html#createStream">createStream</a></li>
            
                <li data-name="bridgedb.xrefService~get"><a href="bridgedb.xrefService.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="organism-service.js.html">Source: organism-service.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/* @module OrganismService */

var _ = require('lodash');
var highland = require('highland');
var httpErrors = require('./http-errors.js');
var jsonLdContext = require('./context.json');
var request = require('request');
var csv = require('csv-streamify');
var csvOptions = {objectMode: true, delimiter: '\t'};
var Utilities = require('./utilities.js');

/**
 * Used internally to create a new OrganismService instance
 * @class
 * @protected
 * @alias organismService
 * @memberof bridgedb
 * @param instance
 */
var OrganismService = function(instance) {
  'use strict';
  /**
   * Get all organisms currently supported by BridgeDB.
   *
   * @return {Stream&lt;array>} availableOrganisms
   * @return {object[]} availableOrganisms.availableOrganism
   * @return {string} availableOrganisms.availableOrganism.english English name, when available
   * @return {string} availableOrganisms.availableOrganism.latin Latin name
   */
  var getAvailable = function() {
    return Utilities.runOnce('availableOrganisms', getAvailableFromRemoteSource);
  };

  var getAvailableFromRemoteSource = function() {
    var path = '/contents';
    var source = instance.config.apiUrlStub + path;

    return highland(request({
      url: source,
      withCredentials: false
    })
    .pipe(csv(csvOptions)))
    .map(function(array) {
      return {
        english: array[0],
        latin: array[1]
      };
    })
    .map(function(organism) {

      // remove empty properties

      organism = _.omit(organism, function(value) {
        // Note: I intentionally used 'null' as
        // a string, not a native value, because
        // BridgeDB returns the string value
        return value === 'null';
      });

      return organism;
    })
    .collect();
  };

  /**
   * If the organism is not specified but the BridgeDB system code and
   * entity reference identifier are, we can identify the species by
   * trying species until we find one that exists for the system code
   * and identifier.
   *
   * @private
   *
   * @param bridgedbSystemCode
   * @param identifier
   * @return {Stream&lt;object>} organismStream
   * @return {object} organismStream.organism
   * @return {string} organismStream.organism.english English name, when available
   * @return {string} organismStream.organism.latin Latin name
   */
  var getByBridgedbSystemCodeAndIdentifierByCheckingAvailableOrganisms = function(bridgedbSystemCode, identifier) {
    var exists = highland.curry(instance.entityReferenceService.exists, bridgedbSystemCode, identifier);

    var initMethod = function() {
      return getAvailable()
      // TODO sort organisms by number of pathways at WikiPathways. Get that data as part of build step for this library.
      .sequence()
      .flatFilter(function(organism) {
        return exists(organism.latin);
      })
      .head()
      .map(function(organism) {
        return organism;
      });
    };

    return Utilities.runOncePerInstance(instance, 'organism', initMethod);
  };

  /**
   * @param {object} entityReference
   * @param {string} entityReference.bridgedbSystemCode
   * @param {string} entityReference.identifier - the identifier for the entity reference, e.g. '4292' for Entrez Gene.
   * @return {Stream&lt;object>} organism
   * @return {string} organism.english English name, when available
   * @return {string} organism.latin Latin name
   */
  function getByEntityReference(entityReference) {
    var bridgedbSystemCode = entityReference.alternatePrefix[0];
    var identifier = entityReference.identifier;

    return instance.databaseService.getByEntityReference(entityReference)
    .flatMap(function(database) {
      var organism = database.organism;
      if (!!organism) {
        return highland([organism]);
      }

      if (!!bridgedbSystemCode &amp;&amp; !!identifier) {
        return getByBridgedbSystemCodeAndIdentifierByCheckingAvailableOrganisms(bridgedbSystemCode, identifier);
      }
    });
  }

  /**
   * Gets all available information about the organism, including the name in multiple languages.
   *
   * @param {string} iri
   * @return {Stream&lt;object>} organism
   * @return {string} organism.english English name, when available
   * @return {string} organism.latin Latin name
   */
  var getByIri = function(iri) {
    // TODO as part of the build process, query all species like this:
    // http://webservice.bridgedb.org/Human/sourceDataSources
    // http://webservice.bridgedb.org/Human/targetDataSources
    // to get a listing of which datasources go with which species.
    // Save that data as a JSON file.
    // Then use those limitations in this query.
    //
    // Also, look into using the identifiers.org registry data, such
    // as regexes, to work with this:
    // http://www.ebi.ac.uk/miriam/main/export/registry.ttl
    // Notice that datasources.txt already has at least some of these.

    var iriComponents = iri.split('identifiers.org');
    var iriPath = iriComponents[iriComponents.length - 1];

    var iriPathComponents = iriPath.split('/');
    var preferredPrefix = iriPathComponents[1];

    var identifier = iriPathComponents[2];
    var availableOrganisms;
    return instance.databaseService.convertPreferredPrefixToBridgedbSystemCode(preferredPrefix)
    .flatMap(function(bridgedbSystemCode) {
      return getByBridgedbSystemCodeAndIdentifierByCheckingAvailableOrganisms(bridgedbSystemCode, identifier);
    });
  };

  /**
   * @param {object} args
   * @param {string} args.iri IRI for an entity reference, e.g. http://identifiers.org/ncbigene/1234
   * @param {string} [args.language] Default "latin", but user can specify "english".
   * @return {Stream&lt;string>} organismName Organism name in specified language
   * @return {string} 
   */
  function convertEntityReferenceIriToOrganismName(args) {
    var iri = args.iri;
    var language = args.language || instance.config.organism.language;
    return getByIri(iri).map(function(organism) {
      return organism[language];
    });
  }

  /**
   * Take organism as specified by user and return organism as specified by BridgeDB
   *
   * @param {string} input - Can be Latin or English name. In the future, we might include IRIs for organisms.
   * @return {Stream&lt;string>} organismName Latin organism name as used at BridgeDB
   * @return {string}
   */
  function normalize(input) {
    var normalizedInput = Utilities.normalizeText(input);
    return getAvailable().sequence()
    .find(function(organism) {
      var latinName = organism.latin;
      var latinNameComponents = organism.latin.split(' ');
      var latinNameAbbreviated = latinNameComponents[0][0] + latinNameComponents[1];
      var englishName = organism.english;
      return Utilities.normalizeText(latinName) === normalizedInput ||
        Utilities.normalizeText(latinNameAbbreviated) === normalizedInput ||
        Utilities.normalizeText(englishName) === normalizedInput;
    })
    .map(function(organism) {
      return !!organism.latin &amp;&amp; organism.latin;
    });
  }

  /**
   * @private
   *
   * @param {string} providedOrganism Organism Latin name
   */
  function set(providedOrganism) {
    getAvailable().find(function(organism) {
      return organism.latin === providedOrganism;
    })
    .map(function(organism) {
      instance.organism = organism;
    });
  }

  return {
    getAvailable:getAvailable,
    getByEntityReference:getByEntityReference,
    getByIri:getByIri,
    convertEntityReferenceIriToOrganismName:convertEntityReferenceIriToOrganismName,
    normalize:normalize,
    set:set
  };
};

exports = module.exports = OrganismService;
</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Tue Nov 11 2014 16:16:52 GMT-0800 (PST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
