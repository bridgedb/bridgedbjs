<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: database-metadata-service.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"bridgedbjs","disqus":"false","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">bridgedbjs</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="BridgeDb">
            <span class="title">
                <a href="BridgeDb.html">BridgeDb</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.databaseMetadataService">
            <span class="title">
                <a href="bridgedb.databaseMetadataService.html">bridgedb.databaseMetadataService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.databaseMetadataService~get"><a href="bridgedb.databaseMetadataService.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.entityReferenceService">
            <span class="title">
                <a href="bridgedb.entityReferenceService.html">bridgedb.entityReferenceService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.entityReferenceService~createEnrichmentStream"><a href="bridgedb.entityReferenceService.html#createEnrichmentStream">createEnrichmentStream</a></li>
            
                <li data-name="bridgedb.entityReferenceService~enrich"><a href="bridgedb.entityReferenceService.html#enrich">enrich</a></li>
            
                <li data-name="bridgedb.entityReferenceService~exists"><a href="bridgedb.entityReferenceService.html#exists">exists</a></li>
            
                <li data-name="bridgedb.entityReferenceService~map"><a href="bridgedb.entityReferenceService.html#map">map</a></li>
            
                <li data-name="bridgedb.entityReferenceService~normalize"><a href="bridgedb.entityReferenceService.html#normalize">normalize</a></li>
            
                <li data-name="bridgedb.entityReferenceService~searchByAttribute"><a href="bridgedb.entityReferenceService.html#searchByAttribute">searchByAttribute</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.organismService">
            <span class="title">
                <a href="bridgedb.organismService.html">bridgedb.organismService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.organismService~createEntityReferenceToOrganismTransformationStream"><a href="bridgedb.organismService.html#createEntityReferenceToOrganismTransformationStream">createEntityReferenceToOrganismTransformationStream</a></li>
            
                <li data-name="bridgedb.organismService~getAvailable"><a href="bridgedb.organismService.html#getAvailable">getAvailable</a></li>
            
                <li data-name="bridgedb.organismService~getByEntityReference"><a href="bridgedb.organismService.html#getByEntityReference">getByEntityReference</a></li>
            
                <li data-name="bridgedb.organismService~normalize"><a href="bridgedb.organismService.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.xrefService">
            <span class="title">
                <a href="bridgedb.xrefService.html">bridgedb.xrefService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.xrefService~createStream"><a href="bridgedb.xrefService.html#createStream">createStream</a></li>
            
                <li data-name="bridgedb.xrefService~get"><a href="bridgedb.xrefService.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="database-metadata-service.js.html">Source: database-metadata-service.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/* @module DatabaseMetadataService */

var _ = require('lodash');
var highland = require('highland');
var httpErrors = require('./http-errors.js');
var internalContext = require('./context.json');
var request = require('request');
var csv = require('csv-streamify');
var csvOptions = {objectMode: true, delimiter: '\t'};
var Utilities = require('./utilities.js');

/**
 * Used internally to create a new DatabaseMetadataService instance.
 * @class
 * @alias databaseMetadataService
 * @memberof bridgedb
 * @param {object} instance
 */
var DatabaseMetadataService = function(instance) {
  'use strict';

  function init() {
    var source = instance.config.datasourcesUrl;

    return highland(request({
      url: source,
      withCredentials: false
    })
    .pipe(csv(csvOptions)))
    .map(function(array) {
      var db = [array[0]];
      db = db.concat([array[10]]);
      return {
        '@context':internalContext,
        db:db,
        bridgedbSystemCode:array[1],
        website:array[2],
        linkoutPattern:array[3],
        exampleIdentifier:array[4],
        bridgedbType:array[5],
        organism:array[6],
        priority:parseFloat(array[7]),
        miriamRootUrn:array[8],
        identifierPattern:array[9],
      };
    })
    .map(function(databaseMetadata) {

      // remove empty properties

      return _.omit(databaseMetadata, function(value) {
        return value === '' ||
          _.isNaN(value) ||
        _.isNull(value) ||
        _.isUndefined(value);
      });
    })
    .map(function(databaseMetadata) {
      if (!!databaseMetadata.miriamRootUrn &amp;&amp;
          databaseMetadata.miriamRootUrn.indexOf('urn:miriam:') > -1) {

        databaseMetadata.preferredPrefix =
          databaseMetadata.miriamRootUrn.substring(11,
            databaseMetadata.miriamRootUrn.length);
        databaseMetadata.id =
          'http://identifiers.org/' + databaseMetadata.preferredPrefix;
        databaseMetadata['owl:sameAs'] = databaseMetadata['owl:sameAs'] || [];
        databaseMetadata['owl:sameAs'].push(databaseMetadata.miriamRootUrn);
      }
      delete databaseMetadata.miriamRootUrn;
      return databaseMetadata;
    })
    .map(function(databaseMetadata) {
      if (!!databaseMetadata.bridgedbType) {
        if (databaseMetadata.bridgedbType === 'gene' ||
          databaseMetadata.bridgedbType === 'probe' ||
          databaseMetadata.preferredPrefix === 'go') {

          databaseMetadata.gpmlType = 'GeneProduct';
          databaseMetadata.biopaxType = 'DnaReference';
        } else if (databaseMetadata.bridgedbType === 'rna') {
          databaseMetadata.gpmlType = 'Rna';
          databaseMetadata.biopaxType = 'RnaReference';
        } else if (databaseMetadata.bridgedbType === 'protein') {
          databaseMetadata.gpmlType = 'Protein';
          databaseMetadata.biopaxType = 'ProteinReference';
        } else if (databaseMetadata.bridgedbType === 'metabolite') {
          databaseMetadata.gpmlType = 'Metabolite';
          databaseMetadata.biopaxType = 'SmallMoleculeReference';
        } else if (databaseMetadata.bridgedbType === 'pathway') {
          databaseMetadata.gpmlType = 'Pathway';
          databaseMetadata.biopaxType = 'Pathway';
        }
      }

      databaseMetadata.alternatePrefix = [
        databaseMetadata.bridgedbSystemCode
      ];

      return databaseMetadata;
    })
    .collect();
  }

  /**
   * Get all biological databases supported by BridgeDb, with all
   * available metadata, largely as specified in
   * {@link https://github.com/bridgedb/BridgeDb/blob/master/org.bridgedb.bio/resources/org/bridgedb/bio/datasources.txt|datasources.txt}.
   *
   * @return {Stream&lt;array>} databaseMetadataStream
   * @return {object[]} databaseMetadataStream.databaseMetadata
   * @return {string[]} databaseMetadataStream.databaseMetadata.db Database name. See
   *                      {@link http://www.biopax.org/release/biopax-level3.owl#db|biopax:db}.
   * @return {string} databaseMetadataStream.databaseMetadata.website
   * @return {string} databaseMetadataStream.databaseMetadata.linkoutPattern
   * @return {string} databaseMetadataStream.databaseMetadata.exampleIdentifier See
   *                                             {@link http://identifiers.org/idot/exampleIdentifier|idot:exampleIdentifier}.
   * @return {string} databaseMetadataStream.databaseMetadata.bridgedbType Biological type, as used at BridgeDb. See
   *    {@link https://github.com/bridgedb/BridgeDb/blob/master/org.bridgedb.bio/resources/org/bridgedb/bio/datasources.txt|datasources.txt}.
   * @return {string} databaseMetadataStream.databaseMetadata.gpmlType Biological type, as used in GPML at WikiPathways and in PathVisio-Java.
   *                                                                  See {@link http://vocabularies.wikipathways.org/gpml#Type|gpml:Type}.
   * @return {string} databaseMetadataStream.databaseMetadata.biopaxType Biological type as used in Biopax. See the domain for
   *                      {@link http://www.biopax.org/release/biopax-level3.owl#entityReference|biopax:entityReference}.
   * @return {number} databaseMetadataStream.databaseMetadata.priority 1: primary/preferred source of identifiers.
   *     0: secondary/alternate source of identifiers, or source for supplemental information about entity references.
   * @return {string} databaseMetadataStream.databaseMetadata.identifierPattern Regular expression for the identifiers from this database.
   *                                                                  See {@link http://identifiers.org/idot/identifierPattern|idot:identifierPattern}.
   * @return {string} databaseMetadataStream.databaseMetadata.preferredPrefix Abbreviation as used by identifiers.org to identify a database.
   *                                                                  See {@link http://identifiers.org/idot/preferredPrefix|idot:preferredPrefix}.
   * @return {string[]} databaseMetadataStream.databaseMetadata.alternatePrefix Abbreviation as used elsewhere to identify a database, such
   *   as at BridgeDb (bridgedbSystemCode located both here and on its own). See {@link http://identifiers.org/idot/alternatePrefix|idot:alternatePrefix}.
   * @return {string} databaseMetadataStream.databaseMetadata.bridgedbSystemCode See
   *    {@link https://github.com/bridgedb/BridgeDb/blob/master/org.bridgedb.bio/resources/org/bridgedb/bio/datasources.txt|datasources.txt}.
   * @return {string} databaseMetadataStream.databaseMetadata.id Preferred {@link http://www.w3.org/TR/json-ld/#iris|IRI}
   *                                                                        (usually a persistent URL) for identifying a database.
   * @return {string[]} databaseMetadataStream.databaseMetadata[owl:sameAs] Alternate IRI for identifying a database.
   *                                                        See {@link http://www.w3.org/TR/owl-ref/#sameAs-def|owl:sameAs}.
   */
  var get = function() {
    return Utilities.runOnce('databaseMetadataSet', init);
  };

  var getByParameterSet = function(providedParameterSetName,
      providedParameterSet,
      databaseMetadataSet) {
    providedParameterSet = _.isArray(providedParameterSet) ?
      providedParameterSet : [providedParameterSet];

    var matchingDatabase =
      databaseMetadataSet.filter(function(databaseMetadata) {
      return !_.isEmpty(
        _.intersection(
          databaseMetadata[providedParameterSetName],
          providedParameterSet
        )
      );
    });

    // second attempt. if first attempt failed, we get a little looser about the match here on the second attempt.
    if (!matchingDatabase) {
      var providedParameterSetNormalized =
        Utilities.normalizeTextArray(providedParameterSet);
      matchingDatabase = databaseMetadataSet.filter(function(databaseMetadata) {
        var databaseMetadataParameterSetNormalized =
        Utilities.normalizeTextArray(
          databaseMetadataSet[providedParameterSetName]
        );
        return !_.isEmpty(
          _.intersection(databaseMetadataParameterSetNormalized,
            providedParameterSetNormalized)
        );
      });
    }

    // if second attempt fails, we give up.
    if (!matchingDatabase || matchingDatabase.length === 0) {
      var message = 'Could not find a BridgeDb-supported database metadata' +
        ' for any of the provided ' + providedParameterSetName +
         ' parameters "' + JSON.stringify(providedParameterSet) + '"';
      return new Error(message);
    }

    return matchingDatabase[0];
  };

  var getByName = function(dbs) {
    var getByNameWhenDatabasesLoad =
      highland.curry(getByParameterSet, 'db', dbs);

    return get().map(function(result) {
      return result;
    })
    .map(getByNameWhenDatabasesLoad);
  };

  function getByAlternatePrefix(alternatePrefixes) {
    var getByAlternatePrefixWhenDatabasesLoad =
      highland.curry(getByParameterSet, 'alternatePrefix', alternatePrefixes);
    return get().map(function(result) {
      return result;
    })
    .map(getByAlternatePrefixWhenDatabasesLoad);
  }

  var getByPreferredPrefixWithAllArguments =
    function(preferredPrefix, databaseMetadataSet) {

    var databaseMetadataSetForPreferredPrefixResults =
      databaseMetadataSet.filter(function(databaseMetadata) {
      return databaseMetadata.preferredPrefix === preferredPrefix;
    });

    if (!databaseMetadataSetForPreferredPrefixResults ||
        databaseMetadataSetForPreferredPrefixResults.length === 0) {

      var message = 'Could not find BridgeDb reference matching provided' +
        'identifiers.org preferredPrefix "' + preferredPrefix + '"';
      return new Error(message);
    }
    return databaseMetadataSetForPreferredPrefixResults[0];
  };

  function getByPreferredPrefix(preferredPrefix) {
    var getByPreferredPrefixWhenDatabasesLoad =
      highland.curry(getByPreferredPrefixWithAllArguments, preferredPrefix);

    return get().map(function(result) {
      return result;
    })
    .map(getByPreferredPrefixWhenDatabasesLoad);
  }

  function getByBridgeDbSystemCode(bridgedbSystemCode) {
    var getByBridgeDbSystemCodeWithAllArguments =
      highland.curry(function(bridgedbSystemCode, databaseMetadataSet) {

      var databaseMetadataSetForBridgeDbSystemCodeResults =
        databaseMetadataSet.filter(function(databaseMetadata) {
        return databaseMetadata.bridgedbSystemCode === bridgedbSystemCode;
      });

      if (!databaseMetadataSetForBridgeDbSystemCodeResults ||
        databaseMetadataSetForBridgeDbSystemCodeResults.length === 0) {

        var message = 'No BridgeDb database metadata returned for' +
          ' bridgedbSystemCode "' + bridgedbSystemCode + '"';
        return new Error(message);
      }
      return databaseMetadataSetForBridgeDbSystemCodeResults[0];
    });

    var getWhenDatabasesLoad =
      getByBridgeDbSystemCodeWithAllArguments(bridgedbSystemCode);

    return get().map(getWhenDatabasesLoad);
  }

  var getByEntityReference = function(entityReference) {
    var keyToFunctionMapping = {
      'preferredPrefix': getByPreferredPrefix,
      'alternatePrefix': getByAlternatePrefix,
      'db': getByName,
      'bridgedbSystemCode': getByBridgeDbSystemCode
    };

    return highland([entityReference])
    .map(instance.entityReferenceService.expand)
    .flatMap(function(entityReference) {
      var entityReferenceKeys = _.keys(entityReference);

      return highland.pairs(keyToFunctionMapping)
      .filter(function(pair) {
        return entityReferenceKeys.indexOf(pair[0]) > -1;
      })
      .head()
      .flatMap(function(pair) {
        return pair[1](entityReference[pair[0]]);
      });
    });
  };

  function convertPreferredPrefixToBridgeDbSystemCode(preferredPrefix) {
    return getByPreferredPrefix(preferredPrefix)
      .map(function(databaseMetadata) {
      if (!databaseMetadata) {
        var message = 'No datasource row available for preferredPrefix "' +
          preferredPrefix + '"';
        return new Error(message);
      }
      return databaseMetadata.bridgedbSystemCode;
    });
  }

  return {
    convertPreferredPrefixToBridgeDbSystemCode:
      convertPreferredPrefixToBridgeDbSystemCode,
    get:get,
    getByBridgeDbSystemCode:getByBridgeDbSystemCode,
    getByEntityReference:getByEntityReference,
    getByName:getByName,
    getByPreferredPrefix:getByPreferredPrefix
  };
};

module.exports = DatabaseMetadataService;
</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Mon Nov 24 2014 20:21:58 GMT-0800 (PST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
