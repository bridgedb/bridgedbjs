<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: data-source.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"bridgedbjs","disqus":"false","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">bridgedbjs</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="BridgeDb">
            <span class="title">
                <a href="BridgeDb.html">BridgeDb</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgeDb.dataSource">
            <span class="title">
                <a href="bridgeDb.dataSource.html">bridgeDb.dataSource</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgeDb.dataSource~getAll"><a href="bridgeDb.dataSource.html#getAll">getAll</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgeDb.entityReference">
            <span class="title">
                <a href="bridgeDb.entityReference.html">bridgeDb.entityReference</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgeDb.entityReference~createEnrichmentStream"><a href="bridgeDb.entityReference.html#createEnrichmentStream">createEnrichmentStream</a></li>
            
                <li data-name="bridgeDb.entityReference~enrich"><a href="bridgeDb.entityReference.html#enrich">enrich</a></li>
            
                <li data-name="bridgeDb.entityReference~exists"><a href="bridgeDb.entityReference.html#exists">exists</a></li>
            
                <li data-name="bridgeDb.entityReference~freeSearch"><a href="bridgeDb.entityReference.html#freeSearch">freeSearch</a></li>
            
                <li data-name="bridgeDb.entityReference~map"><a href="bridgeDb.entityReference.html#map">map</a></li>
            
                <li data-name="bridgeDb.entityReference~normalize"><a href="bridgeDb.entityReference.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgeDb.organism">
            <span class="title">
                <a href="bridgeDb.organism.html">bridgeDb.organism</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgeDb.organism~createEntityReferenceToOrganismTransformationStream"><a href="bridgeDb.organism.html#createEntityReferenceToOrganismTransformationStream">createEntityReferenceToOrganismTransformationStream</a></li>
            
                <li data-name="bridgeDb.organism~getAll"><a href="bridgeDb.organism.html#getAll">getAll</a></li>
            
                <li data-name="bridgeDb.organism~getByEntityReference"><a href="bridgeDb.organism.html#getByEntityReference">getByEntityReference</a></li>
            
                <li data-name="bridgeDb.organism~normalize"><a href="bridgeDb.organism.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgeDb.xref">
            <span class="title">
                <a href="bridgeDb.xref.html">bridgeDb.xref</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgeDb.xref~createStream"><a href="bridgeDb.xref.html#createStream">createStream</a></li>
            
                <li data-name="bridgeDb.xref~get"><a href="bridgeDb.xref.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="data-source.js.html">Source: data-source.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/* @module DataSource */

var _ = require('lodash');
var highland = require('highland');
var httpErrors = require('./http-errors.js');
var internalContext = require('./context.json');
var request = require('request');
var csv = require('csv-streamify');
var csvOptions = {objectMode: true, delimiter: '\t'};
var Utilities = require('./utilities.js');

/**
 * Used internally to create a new DataSource instance. See related
 * {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.html|DataSource}
 * from BridgeDb-Java.
 * @class
 * @alias dataSource
 * @memberof bridgeDb
 * @param {object} instance
 */
var DataSource = function(instance) {
  'use strict';

  function init() {
    var source = instance.config.dataSourcesUrl;

    return highland(request({
      url: source,
      withCredentials: false
    })
    .pipe(csv(csvOptions)))
    .map(function(array) {
      return {
        '@context':internalContext,
        db:_([array[0], array[10]])
            .uniq()
            .compact()
            .value(),
        bridgeDbSystemCode:array[1],
        mainUrl:array[2],
        urlPattern:array[3],
        exampleIdentifier:array[4],
        bridgeDbType:array[5],
        organism:array[6],
        isPrimary:Boolean(array[7]),
        miriamRootUrn:array[8],
        identifierPattern:array[9],
      };
    })
    .map(function(dataSource) {

      // remove empty properties

      return _.omit(dataSource, function(value) {
        return value === '' ||
          _.isNaN(value) ||
        _.isNull(value) ||
        _.isUndefined(value);
      });
    })
    .map(function(dataSource) {
      if (!!dataSource.miriamRootUrn &amp;&amp;
          dataSource.miriamRootUrn.indexOf('urn:miriam:') > -1) {

        dataSource.preferredPrefix =
          dataSource.miriamRootUrn.substring(11,
            dataSource.miriamRootUrn.length);
        dataSource.id =
          'http://identifiers.org/' + dataSource.preferredPrefix;
        dataSource['owl:sameAs'] = dataSource['owl:sameAs'] || [];
        dataSource['owl:sameAs'].push(dataSource.miriamRootUrn);
      }
      delete dataSource.miriamRootUrn;
      return dataSource;
    })
    .map(function(dataSource) {
      if (!!dataSource.bridgeDbType) {
        dataSource['@type'] = [];
        if (dataSource.bridgeDbType === 'gene' ||
          dataSource.bridgeDbType === 'probe' ||
          dataSource.preferredPrefix === 'go') {

          dataSource['@type'].push('gpml:GeneProduct');
          dataSource['@type'].push('biopax:DnaReference');
        } else if (dataSource.bridgeDbType === 'rna') {
          dataSource['@type'].push('gpml:Rna');
          dataSource['@type'].push('biopax:RnaReference');
        } else if (dataSource.bridgeDbType === 'protein') {
          dataSource['@type'].push('gpml:Protein');
          dataSource['@type'].push('biopax:ProteinReference');
        } else if (dataSource.bridgeDbType === 'metabolite') {
          dataSource['@type'].push('gpml:Metabolite');
          dataSource['@type'].push('biopax:SmallMoleculeReference');
        } else if (dataSource.bridgeDbType === 'pathway') {
          dataSource['@type'].push('gpml:Pathway');
          dataSource['@type'].push('biopax:Pathway');
        }
      }

      dataSource.alternatePrefix = [
        dataSource.bridgeDbSystemCode
      ];

      return dataSource;
    })
    .collect();
  }

  /**
   * Get all biological data sources supported by BridgeDb, with all
   * available metadata, largely as specified in
   * {@link https://github.com/bridgedb/BridgeDb/blob/master/org.bridgedb.bio/resources/org/bridgedb/bio/datasources.txt|datasources.txt}.
   *
   * @return {Stream&lt;array>} dataSourceStream
   * @return {object[]} dataSourceStream.dataSource
   * @return {string[]} dataSourceStream.dataSource.db Database name. See
   *                      {@link http://www.biopax.org/release/biopax-level3.owl#db|biopax:db}.
   * @return {string} dataSourceStream.dataSource.mainUrl See
   *  {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.html#getMainUrl()|Java documentation}.
   * @return {string} dataSourceStream.dataSource.urlPattern See
   *                        {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.Builder.html#urlPattern(java.lang.String)|Java documentation}.
   * @return {string} dataSourceStream.dataSource.exampleIdentifier See
   *                                             {@link http://identifiers.org/idot/exampleIdentifier|idot:exampleIdentifier}.
   * @return {string} dataSourceStream.dataSource.organism If the data source is for a single organism. See
   *                                        {@link http://www.biopax.org/release/biopax-level3.owl#organism|biopax:organism}.
   * @return {string} dataSourceStream.dataSource.bridgeDbType Biological type, as used at BridgeDb. See
   *                            {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.Builder.html#type(java.lang.String)|Java documentation}.
   * @return {string} dataSourceStream.dataSource['@type'] Biological type, as used in GPML at WikiPathways and in PathVisio-Java.
   *                                                                  See {@link http://vocabularies.wikipathways.org/gpml#Type|gpml:Type}.
   *                                                                   And as used in Biopax. See the domain for
   *                                        {@link http://www.biopax.org/release/biopax-level3.owl#entityReference|biopax:entityReference}.
   * @return {boolean} dataSourceStream.dataSource.isPrimary See Java documentation for
   *                            {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.html#isPrimary()|"isPrimary"} and for
   *                            {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.Builder.html#primary(boolean)|"primary" method}.
   * @return {string} dataSourceStream.dataSource.identifierPattern Regular expression for the identifiers from this data source.
   *                                                                  See {@link http://identifiers.org/idot/identifierPattern|idot:identifierPattern}.
   * @return {string} dataSourceStream.dataSource.preferredPrefix Abbreviation as used by identifiers.org to identify a data source.
   *                                                                  See {@link http://identifiers.org/idot/preferredPrefix|idot:preferredPrefix}.
   * @return {string[]} dataSourceStream.dataSource.alternatePrefix Abbreviation as used elsewhere to identify a data source, such
   *                                                                  as at BridgeDb (bridgeDbSystemCode located both here and on its own).
   *                                                                  See {@link http://identifiers.org/idot/alternatePrefix|idot:alternatePrefix}.
   * @return {string} dataSourceStream.dataSource.bridgeDbSystemCode See
   *                                                {@link http://bridgedb.org/apidoc/2.0/org/bridgedb/DataSource.html#getSystemCode()|Java documentation}.
   * @return {string} dataSourceStream.dataSource.id Preferred {@link http://www.w3.org/TR/json-ld/#iris|IRI}
   *                                                                        (usually a persistent URL) for identifying a data source.
   * @return {string[]} dataSourceStream.dataSource[owl:sameAs] Alternate IRI for identifying a data source.
   *                                                        See {@link http://www.w3.org/TR/owl-ref/#sameAs-def|owl:sameAs}.
   */
  var getAll = function() {
    return Utilities.runOnce('dataSource', init);
  };

  var getByParameterSet = function(providedParameterSetName,
      providedParameterSet,
      dataSources) {
    providedParameterSet = _.isArray(providedParameterSet) ?
      providedParameterSet : [providedParameterSet];

    var matchingDatabase =
      dataSources.filter(function(dataSource) {
      return !_.isEmpty(
        _.intersection(
          dataSource[providedParameterSetName],
          providedParameterSet
        )
      );
    });

    // second attempt. if first attempt failed, we get a little looser about the match here on the second attempt.
    if (!matchingDatabase) {
      var providedParameterSetNormalized =
        Utilities.normalizeTextArray(providedParameterSet);
      matchingDatabase = dataSources.filter(function(dataSource) {
        var dataSourceParameterSetNormalized =
        Utilities.normalizeTextArray(
          dataSources[providedParameterSetName]
        );
        return !_.isEmpty(
          _.intersection(dataSourceParameterSetNormalized,
            providedParameterSetNormalized)
        );
      });
    }

    // if second attempt fails, we give up.
    if (!matchingDatabase || matchingDatabase.length === 0) {
      var message = 'Could not find a BridgeDb-supported data source' +
        ' for any of the provided ' + providedParameterSetName +
         ' parameters "' + JSON.stringify(providedParameterSet) + '"';
      return new Error(message);
    }

    return matchingDatabase[0];
  };

  var getByName = function(dbs) {
    var getByNameWhenDatabasesLoad =
      highland.curry(getByParameterSet, 'db', dbs);

    return getAll().map(function(result) {
      return result;
    })
    .map(getByNameWhenDatabasesLoad);
  };

  function getByAlternatePrefix(alternatePrefixes) {
    var getByAlternatePrefixWhenDatabasesLoad =
      highland.curry(getByParameterSet, 'alternatePrefix', alternatePrefixes);
    return getAll().map(function(result) {
      return result;
    })
    .map(getByAlternatePrefixWhenDatabasesLoad);
  }

  var getByPreferredPrefixWithAllArguments =
    function(preferredPrefix, dataSources) {

    var dataSourcesForPreferredPrefixResults =
      dataSources.filter(function(dataSource) {
      return dataSource.preferredPrefix === preferredPrefix;
    });

    if (!dataSourcesForPreferredPrefixResults ||
        dataSourcesForPreferredPrefixResults.length === 0) {

      var message = 'Could not find BridgeDb-supported data source matching' +
        ' provided identifiers.org preferredPrefix "' + preferredPrefix + '"';
      return new Error(message);
    }
    return dataSourcesForPreferredPrefixResults[0];
  };

  function getByPreferredPrefix(preferredPrefix) {
    var getByPreferredPrefixWhenDatabasesLoad =
      highland.curry(getByPreferredPrefixWithAllArguments, preferredPrefix);

    return getAll().map(function(result) {
      return result;
    })
    .map(getByPreferredPrefixWhenDatabasesLoad);
  }

  function getByBridgeDbSystemCode(bridgeDbSystemCode) {
    var getByBridgeDbSystemCodeWithAllArguments =
      highland.curry(function(bridgeDbSystemCode, dataSources) {

      var dataSourcesForBridgeDbSystemCodeResults =
        dataSources.filter(function(dataSource) {
        return dataSource.bridgeDbSystemCode === bridgeDbSystemCode;
      });

      if (!dataSourcesForBridgeDbSystemCodeResults ||
        dataSourcesForBridgeDbSystemCodeResults.length === 0) {

        var message = 'No BridgeDb-supported data source returned for' +
          ' bridgeDbSystemCode "' + bridgeDbSystemCode + '"';
        return new Error(message);
      }
      return dataSourcesForBridgeDbSystemCodeResults[0];
    });

    var getWhenDatabasesLoad =
      getByBridgeDbSystemCodeWithAllArguments(bridgeDbSystemCode);

    return getAll().map(getWhenDatabasesLoad);
  }

  var getByEntityReference = function(entityReference) {
    var keyToFunctionMapping = {
      'preferredPrefix': getByPreferredPrefix,
      'alternatePrefix': getByAlternatePrefix,
      'db': getByName,
      'bridgeDbSystemCode': getByBridgeDbSystemCode
    };

    return highland([entityReference])
    .map(instance.entityReference.expand)
    .flatMap(function(entityReference) {
      var entityReferenceKeys = _.keys(entityReference);

      return highland.pairs(keyToFunctionMapping)
      .filter(function(pair) {
        return entityReferenceKeys.indexOf(pair[0]) > -1;
      })
      .head()
      .flatMap(function(pair) {
        return pair[1](entityReference[pair[0]]);
      });
    });
  };

  function convertPreferredPrefixToBridgeDbSystemCode(preferredPrefix) {
    return getByPreferredPrefix(preferredPrefix)
      .map(function(dataSource) {
      if (!dataSource) {
        var message = 'No BridgeDb-supported data source available for ' +
           'preferredPrefix + "' + preferredPrefix + '"';
        return new Error(message);
      }
      return dataSource.bridgeDbSystemCode;
    });
  }

  return {
    convertPreferredPrefixToBridgeDbSystemCode:
      convertPreferredPrefixToBridgeDbSystemCode,
    getAll:getAll,
    getByBridgeDbSystemCode:getByBridgeDbSystemCode,
    getByEntityReference:getByEntityReference,
    getByName:getByName,
    getByPreferredPrefix:getByPreferredPrefix
  };
};

module.exports = DataSource;
</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Wed Nov 26 2014 00:13:59 GMT-0800 (PST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
