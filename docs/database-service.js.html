<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: database-service.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"bridgedbjs","disqus":"true","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">bridgedbjs</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="Bridgedb">
            <span class="title">
                <a href="Bridgedb.html">Bridgedb</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.databaseService">
            <span class="title">
                <a href="bridgedb.databaseService.html">bridgedb.databaseService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.entityReferenceService">
            <span class="title">
                <a href="bridgedb.entityReferenceService.html">bridgedb.entityReferenceService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.entityReferenceService~createBridgedbXrefsUrlAdderStream"><a href="bridgedb.entityReferenceService.html#createBridgedbXrefsUrlAdderStream">createBridgedbXrefsUrlAdderStream</a></li>
            
                <li data-name="bridgedb.entityReferenceService~enrich"><a href="bridgedb.entityReferenceService.html#enrich">enrich</a></li>
            
                <li data-name="bridgedb.entityReferenceService~exists"><a href="bridgedb.entityReferenceService.html#exists">exists</a></li>
            
                <li data-name="bridgedb.entityReferenceService~map"><a href="bridgedb.entityReferenceService.html#map">map</a></li>
            
                <li data-name="bridgedb.entityReferenceService~normalize"><a href="bridgedb.entityReferenceService.html#normalize">normalize</a></li>
            
                <li data-name="bridgedb.entityReferenceService~searchByAttribute"><a href="bridgedb.entityReferenceService.html#searchByAttribute">searchByAttribute</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.organismService">
            <span class="title">
                <a href="bridgedb.organismService.html">bridgedb.organismService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.organismService~createEntityReferenceToOrganismTransformationStream"><a href="bridgedb.organismService.html#createEntityReferenceToOrganismTransformationStream">createEntityReferenceToOrganismTransformationStream</a></li>
            
                <li data-name="bridgedb.organismService~getAvailable"><a href="bridgedb.organismService.html#getAvailable">getAvailable</a></li>
            
                <li data-name="bridgedb.organismService~getByEntityReference"><a href="bridgedb.organismService.html#getByEntityReference">getByEntityReference</a></li>
            
                <li data-name="bridgedb.organismService~normalize"><a href="bridgedb.organismService.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="bridgedb.xrefService">
            <span class="title">
                <a href="bridgedb.xrefService.html">bridgedb.xrefService</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="bridgedb.xrefService~createStream"><a href="bridgedb.xrefService.html#createStream">createStream</a></li>
            
                <li data-name="bridgedb.xrefService~get"><a href="bridgedb.xrefService.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="database-service.js.html">Source: database-service.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/* @module DatabaseService */

var _ = require('lodash');
var highland = require('highland');
var httpErrors = require('./http-errors.js');
var internalContext = require('./context.json');
var request = require('request');
var csv = require('csv-streamify');
var csvOptions = {objectMode: true, delimiter: '\t'};
var Utilities = require('./utilities.js');

/**
 * Used internally to create a new DatabaseService instance.
 * @class
 * @protected
 * @alias databaseService
 * @memberof bridgedb
 * @param instance
 */
var DatabaseService = function(instance) {
  'use strict';

  function init() {
    var source = instance.config.datasourcesUrl;

    return highland(request({
      url: source,
      withCredentials: false
    })
    .pipe(csv(csvOptions)))
    .map(function(array) {
      var db = [array[0]];
      db = db.concat([array[10]]);
      return {
        '@context':internalContext,
        db:db,
        bridgedbSystemCode:array[1],
        website:array[2],
        linkoutPattern:array[3],
        exampleIdentifier:array[4],
        bridgedbType:array[5],
        organism:array[6],
        priority:parseFloat(array[7]),
        miriamRootUrn:array[8],
        identifierPattern:array[9],
      };
    })
    .map(function(database) {

      // remove empty properties

      return _.omit(database, function(value) {
        return value === '' || _.isNaN(value) || _.isNull(value) || _.isUndefined(value);
      });
    })
    .map(function(database) {
      if (!!database.miriamRootUrn &amp;&amp; database.miriamRootUrn.indexOf('urn:miriam:') > -1) {
        database.preferredPrefix = database.miriamRootUrn.substring(11, database.miriamRootUrn.length);
        database.id = 'http://identifiers.org/' + database.preferredPrefix;
        database['owl:sameAs'] = database['owl:sameAs'] || [];
        database['owl:sameAs'].push(database.miriamRootUrn);
      }
      delete database.miriamRootUrn;
      return database;
    })
    .map(function(database) {
      if (!!database.bridgedbType) {
        if (database.bridgedbType === 'gene' || database.bridgedbType === 'probe' || database.preferredPrefix === 'go') {
          database.gpmlType = 'GeneProduct';
          database.biopaxType = 'DnaReference';
        } else if (database.bridgedbType === 'rna') {
          database.gpmlType = 'Rna';
          database.biopaxType = 'RnaReference';
        } else if (database.bridgedbType === 'protein') {
          database.gpmlType = 'Protein';
          database.biopaxType = 'ProteinReference';
        } else if (database.bridgedbType === 'metabolite') {
          database.gpmlType = 'Metabolite';
          database.biopaxType = 'SmallMoleculeReference';
        } else if (database.bridgedbType === 'pathway') {
          database.gpmlType = 'Pathway';
          database.biopaxType = 'Pathway';
        }
      }

      database.alternatePrefix = [
        database.bridgedbSystemCode
      ];

      return database;
    })
    .collect();
  }

  var get = function() {
    return Utilities.runOnce('databases', init);
  };

  var getByParameterSet = function (providedParameterSetName, providedParameterSet, databases) {
    providedParameterSet = _.isArray(providedParameterSet) ? providedParameterSet : [providedParameterSet];

    var matchingDatabase = databases.filter(function(database) {
      return !_.isEmpty(_.intersection(database[providedParameterSetName], providedParameterSet));
    });

    // second attempt. if first attempt failed, we get a little looser about the match here on the second attempt.
    if (!matchingDatabase) {
      var providedParameterSetNormalized = Utilities.normalizeTextArray(providedParameterSet);
      matchingDatabase = databases.filter(function(database) {
        var databaseParameterSetNormalized = Utilities.normalizeTextArray(databases[providedParameterSetName]);
        return !_.isEmpty(_.intersection(databaseParameterSetNormalized, providedParameterSetNormalized));
      });
    }

    // if second attempt fails, we give up.
    if (!matchingDatabase || matchingDatabase.length === 0) {
      return new Error('Could not find a BridgeDB-supported database for any of the provided ' + providedParameterSetName + ' parameters "' + JSON.stringify(providedParameterSet) + '"');
    }

    return matchingDatabase[0];
  };

  /*
  var getByNameWithAllArguments = function(db, databases) {
    var database = _.find(databases, function(row) {
      return row.db === db;
    });

    // second attempt. if first attempt failed, we get a little looser about the match here on the second attempt.
    if (!database) {
      database = _.find(databases, function(row) {
        return Utilities.normalizeText(row.db) === Utilities.normalizeText(db);
      });
    }

    // if second attempt fails, we give up.
    if (!database) {
      return new Error('No BridgeDB databases returned for db "' + db + '"');
    }

    return database;
  };
  //*/

  var getByName = function(dbs) {
    var getByNameWhenDatabasesLoad = highland.curry(getByParameterSet, 'db', dbs);

    return get().map(function(result) {
      return result;
    })
    .map(getByNameWhenDatabasesLoad);
  };

  function getByAlternatePrefix(alternatePrefixes) {
    var getByAlternatePrefixWhenDatabasesLoad = highland.curry(getByParameterSet, 'alternatePrefix', alternatePrefixes);
    return get().map(function(result) {
      return result;
    })
    .map(getByAlternatePrefixWhenDatabasesLoad);
  }

  var getByPreferredPrefixWithAllArguments = function (preferredPrefix, databases) {
    var databasesForPreferredPrefixResults = databases.filter(function(database) {
      return database.preferredPrefix === preferredPrefix;
    });

    if (!databasesForPreferredPrefixResults || databasesForPreferredPrefixResults.length === 0) {
      return new Error('Could not find BridgeDB reference matching provided identifiers.org preferredPrefix "' + preferredPrefix + '"');
    }
    return databasesForPreferredPrefixResults[0];
  };

  function getByPreferredPrefix(preferredPrefix) {
    var getByPreferredPrefixWhenDatabasesLoad = highland.curry(getByPreferredPrefixWithAllArguments, preferredPrefix);
    return get().map(function(result) {
      return result;
    })
    .map(getByPreferredPrefixWhenDatabasesLoad);
  }

  function getByBridgedbSystemCode(bridgedbSystemCode) {
    var getByBridgedbSystemCodeWithAllArguments = highland.curry(function (bridgedbSystemCode, databases) {
      var databasesForBridgedbSystemCodeResults = databases.filter(function(database) {
        return database.bridgedbSystemCode === bridgedbSystemCode;
      });

      if (!databasesForBridgedbSystemCodeResults || databasesForBridgedbSystemCodeResults.length === 0) {
        return new Error('No BridgeDB databases returned for bridgedbSystemCode "' + bridgedbSystemCode + '"');
      }
      return databasesForBridgedbSystemCodeResults[0];
    });

    var getWhenDatabasesLoad = getByBridgedbSystemCodeWithAllArguments(bridgedbSystemCode);

    return get().map(getWhenDatabasesLoad);
  }

  var getByEntityReference = function(entityReference) {
    var keyToFunctionMapping = {
      'preferredPrefix': getByPreferredPrefix,
      'alternatePrefix': getByAlternatePrefix,
      'db': getByName,
      'bridgedbSystemCode': getByBridgedbSystemCode
    };

    return highland([entityReference])
    .map(instance.entityReferenceService.expand)
    .flatMap(function(entityReference) {
      var entityReferenceKeys = _.keys(entityReference);

      return highland.pairs(keyToFunctionMapping)
      .filter(function(pair) {
        return entityReferenceKeys.indexOf(pair[0]) > -1;
      })
      .head()
      .flatMap(function(pair) {
        return pair[1](entityReference[pair[0]]);
      });
    });
  };

  function convertPreferredPrefixToBridgedbSystemCode(preferredPrefix) {
    return getByPreferredPrefix(preferredPrefix).map(function(database) {
      if (!database) {
        return new Error('No datasource row available for preferredPrefix "' + preferredPrefix + '"');
      }
      return database.bridgedbSystemCode;
    });
  }

  return {
    convertPreferredPrefixToBridgedbSystemCode:convertPreferredPrefixToBridgedbSystemCode,
    get:get,
    getByBridgedbSystemCode:getByBridgedbSystemCode,
    getByEntityReference:getByEntityReference,
    getByName:getByName,
    getByPreferredPrefix:getByPreferredPrefix
  };
};

module.exports = DatabaseService;
</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Wed Nov 12 2014 13:55:18 GMT-0800 (PST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
