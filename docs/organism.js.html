<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Source: organism.js</title>
    
    
    
    
    
    <meta property="og:title" content=""/>
    <meta property="og:type" content="website"/>
    <meta property="og:image" content=""/>
    
    <meta property="og:url" content=""/>
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <script src="scripts/jquery.min.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/bootstrap.min.css">
    <link type="text/css" rel="stylesheet" href="styles/jaguar.css">
    
    
    <script>
    var config = {"monospaceLinks":true,"cleverLinks":true,"default":{"outputSourceFiles":true},"applicationName":"bridgedbjs","disqus":"false","googleAnalytics":"","openGraph":{"title":"","type":"website","image":"","site_name":"","url":""},"meta":{"title":"","description":"","keyword":""},"linenums":false};
    </script>
    

    
</head>
<body>
<div id="wrap" class="clearfix">
    
<div class="navigation">
    <h3 class="applicationName"><a href="index.html">bridgedbjs</a></h3>

    <div class="search">
        <input id="search" type="text" class="form-control input-sm" placeholder="Search Documentations">
    </div>
    <ul class="list">
    
        <li class="item" data-name="BridgeDb">
            <span class="title">
                <a href="BridgeDb.html">BridgeDb</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="BridgeDb.Dataset">
            <span class="title">
                <a href="BridgeDb.Dataset.html">BridgeDb.Dataset</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="BridgeDb.Dataset~get"><a href="BridgeDb.Dataset.html#get">get</a></li>
            
                <li data-name="BridgeDb.Dataset~query"><a href="BridgeDb.Dataset.html#query">query</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="BridgeDb.EntityReference">
            <span class="title">
                <a href="BridgeDb.EntityReference.html">BridgeDb.EntityReference</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="BridgeDb.EntityReference~createEnrichmentStream"><a href="BridgeDb.EntityReference.html#createEnrichmentStream">createEnrichmentStream</a></li>
            
                <li data-name="BridgeDb.EntityReference~enrich"><a href="BridgeDb.EntityReference.html#enrich">enrich</a></li>
            
                <li data-name="BridgeDb.EntityReference~exists"><a href="BridgeDb.EntityReference.html#exists">exists</a></li>
            
                <li data-name="BridgeDb.EntityReference~freeSearch"><a href="BridgeDb.EntityReference.html#freeSearch">freeSearch</a></li>
            
                <li data-name="BridgeDb.EntityReference~map"><a href="BridgeDb.EntityReference.html#map">map</a></li>
            
                <li data-name="BridgeDb.EntityReference~normalize"><a href="BridgeDb.EntityReference.html#normalize">normalize</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="BridgeDb.Organism">
            <span class="title">
                <a href="BridgeDb.Organism.html">BridgeDb.Organism</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="BridgeDb.Organism~createEntityReferenceToOrganismTransformationStream"><a href="BridgeDb.Organism.html#createEntityReferenceToOrganismTransformationStream">createEntityReferenceToOrganismTransformationStream</a></li>
            
                <li data-name="BridgeDb.Organism~get"><a href="BridgeDb.Organism.html#get">get</a></li>
            
                <li data-name="BridgeDb.Organism~query"><a href="BridgeDb.Organism.html#query">query</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
        <li class="item" data-name="BridgeDb.Xref">
            <span class="title">
                <a href="BridgeDb.Xref.html">BridgeDb.Xref</a>
                
            </span>
            <ul class="members itemMembers">
            
            </ul>
            <ul class="typedefs itemMembers">
            
            </ul>
            <ul class="methods itemMembers">
            
            <span class="subtitle">Methods</span>
            
                <li data-name="BridgeDb.Xref~get"><a href="BridgeDb.Xref.html#get">get</a></li>
            
            </ul>
            <ul class="events itemMembers">
            
            </ul>
        </li>
    
    </ul>
</div>
    <div class="main">
        <h1 class="page-title" data-filename="organism.js.html">Source: organism.js</h1>
        


    
    <section>
        <article>
            <pre class="prettyprint source "><code>/* @module Organism */

var _ = require('lodash');
var highland = require('highland');
var httpErrors = require('./http-errors.js');
var jsonLdContext = require('./context.json');
var request = require('request');
var csv = require('csv-streamify');
var csvOptions = {objectMode: true, delimiter: '\t'};
var JsonldMatcher = require('./jsonld-matcher.js');
var Utils = require('./utils.js');

/**
 * Used internally to create a new Organism instance
 * @class
 * @protected
 * @memberof BridgeDb
 * @param {Object} instance
 */
var Organism = function(instance) {
  'use strict';

  /**
   * @private
   *
   * Convert organism to Latin name.
   *
   * @param {String} organismIdentifier - Can be name in Latin (full like "Escherichia coli"
   *      or abbreviated like "E. coli") or English. In the future, we might include IRIs for organisms.
   * @return {Stream&lt;String>} organismLatinName Full name in Latin
   * @return {String}
   */
  function _convertToLatinName(organismIdentifier) {
    return _normalize(organismIdentifier).map(function(organism) {
      // returns either the organism name or false
      return !!organism.name &amp;&amp; !!organism.name.la &amp;&amp; organism.name.la;
    });
  }

  /**
   * Create a Node.js/Highland stream through which entity references
   * can be piped to return their associated organism.
   *
   * @return {Stream} entityReferenceToOrganismTransformationStream
   */
  var createEntityReferenceToOrganismTransformationStream = function() {
    return highland.pipeline(function(sourceStream) {
      return highland(sourceStream).flatMap(_getByEntityReference);
    });
  };

  /**
   * @private
   *
   * Get all organisms currently supported by BridgeDb.
   *
   * @return {Stream&lt;Object>} organism
   * @return {Object} organism['@context'] JSON-LD context. You can ignore this.
   * @return {Object[]} organism.name
   * @return {String} organism.name.en English name, when available.
   * @return {String} organism.name.la Full Latin name.
   */
  var _getAll = function() {
    function init() {
      var path = 'contents';
      var source = instance.config.baseIri + path;

      return highland(request({
        url: source,
        withCredentials: false
      })
      .pipe(csv(csvOptions)))
      .map(function(array) {
        var names = {};
        var englishName = array[0];
        var latinName = array[1];

        // Note: I intentionally used 'null' as a string, not a native value,
        // because BridgeDb returns the string value
        if (englishName !== 'null') {
          names.en = englishName;
        }
        if (latinName !== 'null') {
          names.la = latinName;
        }

        return {
          '@context': [
            {
              name: {
                '@id': 'biopax:name',
                '@container': '@language'
              }
            },
            'http://test2.wikipathways.org/v2/contexts/organism.jsonld'
          ],
          name: names
        };
      });
    }

    return Utils._runOnceGlobal('organisms', init);
  };

  /**
   * @private
   *
   * If the organism is not specified but the BridgeDb system code and
   * entity reference identifier are, we can identify the species by
   * trying species until we find one that exists for the system code
   * and identifier.
   *
   * @param bridgeDbSystemCode
   * @param identifier
   * @return {Stream&lt;Object>} organism
   * @return {Object} organism['@context'] JSON-LD context. You can ignore this if
   *                                                  you don't care about semantics.
   * @return {Stream&lt;Object>} organism
   * @return {Object[]} organism.name
   * @return {String} organism.name.en English name, when available.
   * @return {String} organism.name.la Full Latin name.
   */
  var _getByBridgeDbSystemCodeAndIdentifier =
    function(bridgeDbSystemCode, identifier) {
    var exists = highland.curry(instance.entityReference.exists,
        bridgeDbSystemCode, identifier);

    return _getAll()
    // TODO sort organisms by number of pathways at WikiPathways. Get that data as part of build step for this library.
    .flatFilter(function(organism) {
      return exists(organism.name.la);
    })
    .head();
  };

  /**
   * Get one organism.
   *
   * @param {Object|String} searchCriteria
   * @param {String|String[]} [searchCriteria['@type']='Organism']
   * @return {Stream&lt;Object>} organismStream
   */
  function get(searchCriteria) {
    if (_.isEmpty(searchCriteria)) {
      throw new Error('No searchCriteria specified for organism.get');
    }

    return query(searchCriteria).head();
  }

  /**
   * @private
   *
   * Identifies the organism for the provided entity reference and returns all
   * the data BridgeDb has about that organism, which currently is the Latin name
   * and, when available, the English name.
   *
   * @param {Object} entityReference See bridgeDb.entityReference.enrich for information
   *                                  on acceptable entity reference inputs.
   * @return {Stream&lt;Object>} organism
   * @return {Object[]} organism.name
   * @return {String} organism.name.en English name, when available.
   * @return {String} organism.name.la Full Latin name.
   */
  function _getByEntityReference(entityReference) {
    // TODO as part of the build process, query all species like this:
    // http://webservice.bridgedb.org/Human/sourceDataSources
    // http://webservice.bridgedb.org/Human/targetDataSources
    // to get a listing of which datasets go with which species.
    // Save that data as a JSON file.
    // Then use those limitations in this query.

    return instance.entityReference.enrich(entityReference, {
      bridgeDbXrefsUrl: false,
      dataset: true,
      organism: false
    })
    .flatMap(function(entityReference) {
      var organism = entityReference.organism;
      if (!!organism) {
        return highland([organism]).map(_normalize);
      }

      var bridgeDbSystemCode = entityReference.inDataset.bridgeDbSystemCode ||
        _.isArray(entityReference.alternatePrefix) &amp;&amp;
        entityReference.alternatePrefix[0];

      var identifier = entityReference.identifier;

      if (!!bridgeDbSystemCode &amp;&amp; !!identifier) {
        return _getByBridgeDbSystemCodeAndIdentifier(
          bridgeDbSystemCode, identifier);
      } else {
        console.warn('Cannot get organism by entityReference.');
        return entityReference;
      }
    });
  }

  /**
   * @private
   *
   * Each BridgeDb instance has one organism name associated with it. This
   * function gets the organism name once and then always returns that organism name.
   *
   * @param {Object|String} searchCriteria
   * @return {Stream&lt;String>} organismNameNormalized Full Latin name.
   * @return {String}
   */
  function _getInstanceOrganismName(searchCriteria) {
    function initMethod() {
      if (!_.isEmpty(instance.organismNameNonNormalized)) {
        return _setInstanceOrganismName(instance.organismNameNonNormalized);
      } else {
        return get(searchCriteria)
        .map(function(organism) {
          // returns either the organism name or false
          return !!organism.name &amp;&amp; !!organism.name.la &amp;&amp; organism.name.la;
        });
      }
    }

    return Utils._runOncePerInstance(
        instance,
        'organismNameNormalized',
        initMethod
    );
  }

  /**
   * @private
   *
   * Normalize organism.
   *
   * @param {String|Object} organism - Can be name in Latin (full like "Escherichia coli"
   *      or abbreviated like "E. coli") or English. In the future, we might include IRIs for organisms.
   * @return {Stream&lt;Object>} organism
   * @return {Object[]} organism.name
   * @return {String} organism.name.en English name, when available.
   * @return {String} organism.name.la Full Latin name.
   */
  function _normalize(organism) {
    var organismIdentifier;
    if (_.isString(organism)) {
      organismIdentifier = organism;
    } else if (_.isPlainObject(organism)) {
      organismIdentifier = organism.name || organism.latin || organism.english;
    }

    if (!organismIdentifier) {
      console.log(organism);
      throw new Error('Cannot normalize above provided organism.');
    }

    var normalizedOrganismIdentifier =
      JsonldMatcher._normalizeText(organismIdentifier);

    return _getAll()
    .filter(function(organism) {
      var names = organism.name;
      var latinName = names.la;
      var latinNameComponents = latinName.split(' ');
      var latinNameAbbreviated = latinNameComponents[0][0] +
        latinNameComponents[1];
      var englishName = names.en;
      return JsonldMatcher._normalizeText(latinName) ===
        normalizedOrganismIdentifier ||
        JsonldMatcher._normalizeText(latinNameAbbreviated) ===
          normalizedOrganismIdentifier ||
        JsonldMatcher._normalizeText(englishName) ===
          normalizedOrganismIdentifier;
    })
    .head();
  }

  /**
   * Find organisms, either all or a subset by search criteria.
   *
   * @param {Object|String} searchCriteria
   * @param {String|String[]} [searchCriteria['@type']='Organism']
   * @return {Stream&lt;Object>} organismStream
   */
  function query(searchCriteria) {
    if (_.isEmpty(searchCriteria)) {
      return _getAll();
    }

    var typeToFunctionMapping = {
      Organism: _normalize,
      EntityReference: _getByEntityReference,
    };

    var providedType;
    if (_.isString(searchCriteria)) {
      providedType = 'Organism';
    } else {
      providedType = searchCriteria['@type'] || 'Organism';
    }
    providedType = Utils._arrayify(providedType);

    var supportedType = _(typeToFunctionMapping).keys()
    .intersection(providedType)
    .first();

    if (!!supportedType) {
      return typeToFunctionMapping[supportedType](searchCriteria);
    } else {
      throw new Error('Cannot get organism by specified type(s): "' +
          providedType + '"');
    }
  }

  /**
   * @private
   *
   * Set the current organism for this instance so we don't have to look it up every time.
   *
   * @param {String|Object} organism The single organism for this bridgedbjs instance. It is
   *                                 preferably the full Latin name. If you need to work
   *                                 with another organism, create another bridgedbjs instance.
   * @param {Boolean} normalize Normalize the provided organism to ensure it matches what
   *                                 the BridgeDb API expects.
   * @return {Stream&lt;String>} Normalized organism name. Note that if args.normalize is set to false,
   *                          the returned value will be whatever was provided as args.organism.
   */
  function _setInstanceOrganismName(organism, normalize) {
    normalize = normalize || true;

    if (normalize) {
      var initMethod = highland.partial(_convertToLatinName, organism);
      return Utils._runOncePerInstance(
          instance,
          // TODO why can't I set this to organismNameNormalized?
          // There appears to be a conflict with having the same name
          // here and in _getInstanceOrganismName(), so for now, I'm
          // setting this to organismNameNormalizedAsSet, but I don't know
          // why I need to.
          'organismNameNormalizedAsSet',
          initMethod
      );
    } else {
      instance.organismNameNonNormalized = organism;
      return highland([organism]);
    }
  }

  return {
    createEntityReferenceToOrganismTransformationStream:
      createEntityReferenceToOrganismTransformationStream,
    get:get,
    _getInstanceOrganismName:_getInstanceOrganismName,
    query:query,
    _setInstanceOrganismName:_setInstanceOrganismName
  };
};

exports = module.exports = Organism;
</code></pre>
        </article>
    </section>






        
        <!-- disqus code -->
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        <!-- // disqus code -->
        

        <footer>
            Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha9</a> on Fri Dec 19 2014 19:01:37 GMT-0800 (PST)
        </footer>
    </div>
</div>
<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
<script src="scripts/main.js"></script>
</body>
</html>
